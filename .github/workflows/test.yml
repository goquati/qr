name: Test All Platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-jvm:
    name: Test JVM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run JVM tests
        run: ./gradlew jvmTest

  test-js-nodejs:
    name: Test JavaScript (Node.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run JS Node.js tests
        run: ./gradlew jsNodeTest

  test-js-browser:
    name: Test JavaScript (Browser)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run JS Browser tests
        run: ./gradlew jsBrowserTest

  test-wasm-js:
    name: Test WASM JS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run WASM JS tests
        run: ./gradlew wasmJsBrowserTest

  test-linux-x64:
    name: Test Linux X64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run Linux X64 tests
        run: ./gradlew linuxX64Test

  test-linux-arm64:
    name: Test Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run Linux ARM64 tests
        run: ./gradlew linuxArm64Test

  test-windows-x64:
    name: Test Windows X64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run Windows X64 tests
        run: .\gradlew mingwX64Test

  test-macos-x64:
    name: Test macOS X64
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run macOS X64 tests
        run: ./gradlew macosX64Test

  test-macos-arm64:
    name: Test macOS ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run macOS ARM64 tests
        run: ./gradlew macosArm64Test

  test-ios:
    name: Test iOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run iOS X64 tests
        run: ./gradlew iosX64Test
      - name: Run iOS Simulator ARM64 tests
        run: ./gradlew iosSimulatorArm64Test

  test-tvos:
    name: Test tvOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run tvOS Simulator ARM64 tests
        run: ./gradlew tvosSimulatorArm64Test

  test-watchos:
    name: Test watchOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run watchOS Simulator ARM64 tests
        run: ./gradlew watchosSimulatorArm64Test

  test-android-native:
    name: Test Android Native
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Run Android Native X64 tests
        run: ./gradlew androidNativeX64Test
      - name: Run Android Native X86 tests
        run: ./gradlew androidNativeX86Test
      - name: Run Android Native ARM32 tests
        run: ./gradlew androidNativeArm32Test
      - name: Run Android Native ARM64 tests
        run: ./gradlew androidNativeArm64Test

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Generate coverage report
        run: ./gradlew koverVerify

  all-tests:
    name: All Tests Passed
    needs: [ test-jvm, test-js-nodejs, test-js-browser, test-wasm-js, test-linux-x64, test-linux-arm64, test-windows-x64, test-macos-x64, test-macos-arm64, test-ios, test-tvos, test-watchos, test-android-native, coverage ]
    runs-on: ubuntu-latest
    steps:
      - name: All platform tests completed successfully
        run: echo "All tests passed!"

